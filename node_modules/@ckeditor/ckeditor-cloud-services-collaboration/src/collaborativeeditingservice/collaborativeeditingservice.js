/*
 *             Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
 *
 *
 *
 *
 *          +---------------------------------------------------------------------------------+
 *          |                                                                                 |
 *          |                                 Hello stranger!                                 |
 *          |                                                                                 |
 *          |                                                                                 |
 *          |   What you're currently looking at is the source code of a legally protected,   |
 *          |    proprietary software. Any attempts to deobfuscate / disassemble this code    |
 *          |               are forbidden and will result in legal consequences.              |
 *          |                                                                                 |
 *          |                                                                                 |
 *          +---------------------------------------------------------------------------------+
 *
 *
 *
 *
 */
import{v4 as _0x2f002e}from'uuid';import{EmitterMixin}from'ckeditor5/src/utils.js';import _0x486835 from'./../messagescompressor.js';import _0x462038 from'./../sessions/sessions.js';import _0x4c6993 from'./messages/collaborativeeditingconnectmessage.js';import _0x22c88b from'./messages/collaborativeeditingupdatemessage.js';import _0x2f40f8 from'./messages/collaborativeeditingreconnectmessage.js';import _0x46ae64 from'./responses/collaborativeeditingresponse.js';import _0x25b4df from'./responses/collaborativeeditingconnectresponse.js';import _0x493748 from'./../websocketgateway/websocketgateway.js';import _0x3518a5 from'../ckeditorcloudserviceserror.js';import _0x383e54 from'../errors/ServiceNotConnectedError.js';import _0x2a141a from'./responses/getdocumentdetailsresponse.js';import _0x437a55 from'./messages/getdocumentdetailsmessage.js';export const _SERVICE=0x1;class CollaborativeEditingService extends/* #__PURE__ -- @preserve */
EmitterMixin(){constructor(_0x58bb62,_0x5bff90){if(super(),!_0x58bb62)throw new TypeError('Param\x20\x22bundleVersion\x22\x20must\x20be\x20provided.');this['_id']=null!=_0x5bff90?_0x5bff90:_0x2f002e(),this['_isConnected']=!0x1,this['_bundleVersion']=_0x58bb62;}['getId'](){return this['_id'];}['isConnected'](){return this['_isConnected'];}['connect'](_0x3e5418,_0x3b24e3={'buffers':[],'types':[]},_0x2968ec){const _0x4eae69=new _0x4c6993(this['getId'](),_0x3b24e3['buffers'],_0x3b24e3['types'],this['_bundleVersion'],_0x2968ec);return this['_connect'](_0x3e5418,_0x4eae69);}['reconnect'](_0x9078d6,_0x44c391){if(this['isConnected']())throw new _0x3518a5('Cannot\x20reconnect\x20to\x20already\x20connected\x20service.',_0x9078d6);return this['_connect'](_0x9078d6,new _0x2f40f8(this['getId'](),_0x44c391,this['_bundleVersion']));}['disconnect'](){this['_isConnected']&&(this['_isConnected']=!0x1,this['_wsGateway']&&(this['stopListening'](this['_wsGateway']),this['_wsGateway']=void 0x0),this['_channel']&&(this['stopListening'](this['_channel']),this['_channel']=void 0x0),this['_connectedSessions']&&(this['_connectedSessions']['disconnect'](),this['_connectedSessions']=void 0x0),this['fire']('disconnected'),this['stopListening']());}async['getDocumentDetails'](){const _0x1a7eb4=new _0x437a55(this['getId']());if(!this['_wsGateway'])throw new _0x383e54('Collaborative\x20Editing',this);const _0xc1cbc1=await this['_wsGateway']['_sendRequest'](0x1,_0x437a55['TYPE'],_0x486835['encode'](_0x1a7eb4));return _0x486835['decode'](_0xc1cbc1,_0x2a141a);}async['sendOperations'](_0x2c6976,_0x18635d,_0x1ade89){if(!_0x2c6976||!_0x2c6976['types']||!_0x2c6976['types']['length'])throw new _0x3518a5('Cannot\x20send\x20empty\x20update.',this['_wsGateway']);const _0x511ca6='number'==typeof _0x18635d?_0x18635d:parseInt(_0x18635d);if(!Number['isInteger'](_0x511ca6)||_0x511ca6<0x0)throw new _0x3518a5('Base\x20version\x20not\x20provided.',this['_wsGateway']);const _0x231f9b=new _0x22c88b(this['getId'](),_0x2c6976['buffers'],_0x2c6976['types'],_0x511ca6,[],_0x1ade89);if(!this['_wsGateway']||!this['_isConnected'])throw new _0x383e54('Collaborative\x20Editing',this);const _0x11c97a=await this['_wsGateway']['_sendRequest'](0x1,_0x22c88b['TYPE'],_0x486835['encode'](_0x231f9b));return _0x486835['decode'](_0x11c97a,_0x46ae64);}async['getConnectedSessions'](){if(!this['_isConnected'])throw new _0x383e54('Collaborative\x20Editing',this);return this['_connectedSessions']||(this['_connectedSessions']=await _0x462038['getConnectedSessions'](this['_wsGateway'],this['_id'],0x1)),this['_connectedSessions'];}static['getConnectedSessions'](_0x25ab10,_0x5f38fb){return _0x462038['getConnectedSessions'](_0x25ab10,_0x5f38fb,0x1);}async['_connect'](_0x2975eb,_0x3f773d){if(this['isConnected']())return;if(_0x2975eb['state']!==_0x493748['STATE_CONNECTED'])throw new _0x3518a5('WebSocket\x20Gateway\x20is\x20not\x20connected.',_0x2975eb);this['_wsGateway']=_0x2975eb,this['stopListening'](_0x2975eb,'change:state');const _0xb613b1=await _0x2975eb['_sendRequest'](0x1,_0x3f773d['constructor']['TYPE'],_0x486835['encode'](_0x3f773d)),_0x3e0dac=_0x486835['decode'](_0xb613b1,_0x25b4df);return this['listenTo'](_0x2975eb,'change:state',(_0x22b526,_0x5f0350,_0xd12709)=>this['_onWsGatewayStateChange'](_0xd12709),{'priority':_0x493748['_CHANGE_STATE_EVENT_PRIORITY']}),this['_connectToChannel'](_0x2975eb,_0x3e0dac['channel']),this['_isConnected']=!0x0,this['fire']('connected'),_0x3e0dac;}['_connectToChannel'](_0x52e8cb,_0x381e93){this['_channel']=_0x52e8cb['_getChannel'](0x1,_0x381e93),this['listenTo'](this['_channel'],this['_channel']['getEventName'](_0x22c88b['TYPE']),(_0x234907,_0xcae90f)=>{const _0x10b5c5=_0x486835['decode'](_0xcae90f,_0x22c88b);this['fire']('operationsReceived',_0x10b5c5['baseVersion'],_0x10b5c5['data'],_0x10b5c5['metadata']);});}['_onWsGatewayStateChange'](_0x4cb5e1){_0x4cb5e1===_0x493748['STATE_DISCONNECTED']&&this['disconnect']();}}CollaborativeEditingService['_SERVICE']=0x1;export default CollaborativeEditingService;