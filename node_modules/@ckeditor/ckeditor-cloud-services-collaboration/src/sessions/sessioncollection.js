/*
 *             Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
 *
 *
 *
 *
 *          +---------------------------------------------------------------------------------+
 *          |                                                                                 |
 *          |                                 Hello stranger!                                 |
 *          |                                                                                 |
 *          |                                                                                 |
 *          |   What you're currently looking at is the source code of a legally protected,   |
 *          |    proprietary software. Any attempts to deobfuscate / disassemble this code    |
 *          |               are forbidden and will result in legal consequences.              |
 *          |                                                                                 |
 *          |                                                                                 |
 *          +---------------------------------------------------------------------------------+
 *
 *
 *
 *
 */
import{Collection}from'ckeditor5/src/utils.js';import _0x6bed86 from'./../users/user.js';import _0x4c4bf7 from'./../websocketgateway/websocketgateway.js';import _0x51ed35 from'./responses/sessionsconnectresponse.js';import _0x28013f from'./messages/sessionsconnectmessage.js';import _0x53b3cb from'./messages/socketconnectmessage.js';import _0x190a10 from'./messages/socketdisconnectmessage.js';import _0x59ea43 from'./../messagescompressor.js';export const _SERVICE=0x3;export default class extends Collection{constructor(_0x27208f,_0x12cca1){super({'idProperty':'id'}),this['_id']=_0x27208f,this['_sessionType']=_0x12cca1,this['_handlers']=new Map(),this['_eventsQueue']=[],this['_isRunning']=!0x1;}async['connect'](_0x4faf81){this['_wsGateway']=_0x4faf81,this['stopListening'](_0x4faf81,'change:state');const _0x8ee272=new _0x28013f(this['_id'],this['_sessionType']);let _0x361299;try{const _0xd8d106=await this['_wsGateway']['_sendRequest'](0x3,_0x28013f['TYPE'],_0x59ea43['encode'](_0x8ee272));_0x361299=_0x59ea43['decode'](_0xd8d106,_0x51ed35);}catch(_0x45bcce){_0x361299=new _0x51ed35(this['_id'],[]);}this['_connectToChannel'](this['_wsGateway'],_0x361299['channel'],this['_sessionType']);const _0x4637cc=await async function(_0x4291ab,_0x41d9a1){const _0x424428=_0x41d9a1['map'](_0x113ea0=>_0x113ea0['userId']),_0x55c67f=_0x424428['length']?await _0x6bed86['getMany'](_0x4291ab,_0x424428):[];return _0x41d9a1['map'](_0x3b23cc=>{const _0xe0224a={'id':_0x3b23cc['id'],'role':_0x3b23cc['role'],'permissions':_0x3b23cc['permissions']};return _0xe0224a['user']=_0x3b23cc['userId']&&_0x55c67f['find'](_0x5f12ce=>_0x5f12ce['id']===_0x3b23cc['userId'])||new _0x6bed86(),_0xe0224a;});}(this['_wsGateway'],_0x361299['sockets']);for(const _0x357144 of _0x4637cc)super['add'](_0x357144);this['_connected']=!0x0,this['fire']('connected'),this['listenTo'](this['_wsGateway'],'change:state',(_0x8d7cb2,_0x418ce9,_0x51df1f)=>this['_onWsGatewayStateChange'](_0x51df1f),{'priority':_0x4c4bf7['_CHANGE_STATE_EVENT_PRIORITY']}),await this['_runQueue']();}['disconnect'](_0x373923=!0x0){if(this['_connected']){for(this['_connected']=!0x1,this['_eventsQueue']=[];this['length'];)super['remove'](0x0);this['_channel']&&(this['stopListening'](this['_channel']),this['_channel']=void 0x0),this['_wsGateway']&&_0x373923&&(this['stopListening'](this['_wsGateway']),this['_wsGateway']=void 0x0),this['fire']('disconnected'),_0x373923&&this['stopListening']();}}['add'](_0x4edcaf,_0x87e854){throw new TypeError('The\x20collection\x20is\x20read-only.');}['remove'](_0x39f308){throw new TypeError('The\x20collection\x20is\x20read-only.');}['_connectToChannel'](_0xb9686b,_0x248c9f,_0x25a4f5){this['_channel']=_0xb9686b['_getChannel'](_0x25a4f5,_0x248c9f),this['_channel']&&(this['_addHandler'](this['_channel'],_0x53b3cb['TYPE'],async _0x5ed44d=>{const _0x53acf8=_0x59ea43['decode'](_0x5ed44d,_0x53b3cb);if(-0x1===this['getIndex'](_0x53acf8['id'])){const _0x3cbf0a={'id':_0x53acf8['id'],'role':_0x53acf8['role'],'permissions':_0x53acf8['permissions']};_0x53acf8['userId']&&(_0x3cbf0a['user']=await _0x6bed86['get'](_0xb9686b,_0x53acf8['userId'])),super['add'](_0x3cbf0a);}}),this['_addHandler'](this['_channel'],_0x190a10['TYPE'],_0x4deabd=>{const _0x150f02=_0x59ea43['decode'](_0x4deabd,_0x190a10);-0x1!==this['getIndex'](_0x150f02['id'])&&super['remove'](_0x150f02['id']);}));}async['_onWsGatewayStateChange'](_0x555a48){_0x555a48===_0x4c4bf7['STATE_DISCONNECTED']&&this['disconnect'](!0x1),_0x555a48===_0x4c4bf7['STATE_CONNECTED']&&await this['connect'](this['_wsGateway']);}async['_runQueue'](){if(this['_isRunning']||!this['_connected'])return;let _0x38260b;for(this['_isRunning']=!0x0;_0x38260b=this['_eventsQueue']['shift']();){const _0x4426aa=this['_handlers']['get'](_0x38260b['eventName']);_0x4426aa&&await _0x4426aa(_0x38260b['data']);}this['_isRunning']=!0x1;}['_addHandler'](_0x4138db,_0x181aa7,_0xd46442){const _0x1fa638=_0x4138db['getEventName'](_0x181aa7,!0x0);this['listenTo'](_0x4138db,_0x1fa638,async(_0x2fd18a,_0x119ca4)=>{const _0x37976d=_0x2fd18a['name'];this['_eventsQueue']['push']({'eventName':_0x37976d,'data':_0x119ca4}),await this['_runQueue']();}),this['_handlers']['set'](_0x1fa638,_0xd46442);}}